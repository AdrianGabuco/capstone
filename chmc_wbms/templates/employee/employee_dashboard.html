{% extends 'employee/employee_base.html' %}

{% block title %}Employee Dashboard{% endblock %}

{% block content %}

<style>
    .modal-dialog {
      width: 800px; /* Set your desired width */
      max-width: 90%; /* Ensure responsiveness */
    }
    .modal-content.one {
      height: 560px; /* Set your desired height */
      max-height: none; /* Ensure responsiveness */
      overflow: visible;
    }
    .privacy-toggle {
      cursor: pointer;
      font-size: 1.5rem;
      margin-left: 10px;
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
    }
    .blur-text {
      filter: blur(5px);
      transition: filter 0.3s;
    }
    .unblur-text {
      filter: none;
      transition: filter 0.3s;
    }

    .special-slots {
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    margin-bottom: 15px;
    }

    .special-slots .form-check {
    margin-bottom: 8px;
    }

    .time-slots-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        max-height: 200px;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
    }
    
    .time-slots-container .form-check {
        margin-bottom: 0;
        padding: 5px;
        background: #f8f9fa;
        border-radius: 4px;
    }

</style>

<div class="container my-4">
    <div class="row text-center">
        <!-- Daily Total Income Card -->
        <div class="col-md-4 mb-3">
            <div class="card p-3">
                <p class="font-weight-bold">Daily Total Income</p>
                <div class="d-flex justify-content-center align-items-center">
                    <h2 id="incomeDisplay" class="text-primary blur-text">₱{{ daily_income|default:"0" }}</h2>
                    <i id="togglePrivacy" class="fa-solid fa-eye-slash privacy-toggle text-primary"></i>
                </div>
                <small class="text-muted">Click amount to view details</small>
                <div class="d-none" id="incomeData">
                    <span data-daily="{{ daily_income|default:'0' }}" 
                          data-weekly="{{ weekly_income|default:'0' }}" 
                          data-monthly="{{ monthly_income|default:'0' }}"></span>
                </div>
            </div>
        </div>
        
        <!-- Daily Total Patient Served Card -->
        <div class="col-md-4 mb-3">
            <a href="{% url 'employee_patients_list' %}" style="text-decoration: none; color: inherit;">
                <div class="card p-3">
                    <p class="font-weight-bold">Daily Total Patient Served</p>
                    <h2 class="text-primary">{{ daily_patients|default:"0" }}</h2>
                    <small class="text-muted">Click to view patient list</small>
                </div>
            </a>
        </div>
        
        <!-- Total Examinations Today Card -->
        <div class="col-md-4 mb-3">
            <a href="{% url 'employee_examination' %}" style="text-decoration: none; color: inherit;">
                <div class="card p-3">
                    <p class="font-weight-bold">Total Examinations Today</p>
                    <h2 class="text-primary">{{ daily_examinations|default:"0" }}</h2>
                    <small class="text-muted">Click to view examinations</small>
                </div>
            </a>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-outline-primary" data-toggle="modal" data-target="#appointmentModal">
            + Add New Appointment
        </button>
    </div>

    <table class="table table-bordered text-center">
        <thead class="thead-light">
            <tr>
                <th>Client</th>
                <th>Description</th>
                <th>Type of Service</th>
                <th>Appointment Date</th>
                <th>Appointment Time</th>
            </tr>
        </thead>
        <tbody>
            {% for appointment in appointments %}
            <tr>
                <td>{{ appointment.client_name }}</td>
                <td>{{ appointment.description }}</td>
                <td>{{ appointment.service_types.all|join:", " }}</td>
                <td>{{ appointment.appointment_date }}</td>
                <td>
                    {% for slot in appointment.appointmenttimeslot_set.all %}
                        {{ slot.time_slot.start_time|time:"h:i A" }} - {{ slot.time_slot.end_time|time:"h:i A" }}
                        {% if not forloop.last %}, {% endif %}
                    {% empty %}
                        No Time Slots
                    {% endfor %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal for Income Details -->
<div class="modal fade" id="incomeModal" tabindex="-1" role="dialog" aria-labelledby="incomeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="incomeModalLabel">Income Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="incomeTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily" type="button" role="tab">Daily</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="weekly-tab" data-bs-toggle="tab" data-bs-target="#weekly" type="button" role="tab">Weekly</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab">Monthly</button>
                    </li>
                </ul>
                <div class="tab-content p-3" id="incomeTabsContent">
                    <div class="tab-pane fade show active" id="daily" role="tabpanel">
                        <h4>Daily Income: ₱<span id="dailyIncomeAmount">{{ daily_income|default:"0" }}</span></h4>
                        <p>Total income from examinations completed today.</p>
                    </div>
                    <div class="tab-pane fade" id="weekly" role="tabpanel">
                        <h4>Weekly Income: ₱<span id="weeklyIncomeAmount">{{ weekly_income|default:"0" }}</span></h4>
                        <p>Total income from examinations completed this week.</p>
                    </div>
                    <div class="tab-pane fade" id="monthly" role="tabpanel">
                        <h4>Monthly Income: ₱<span id="monthlyIncomeAmount">{{ monthly_income|default:"0" }}</span></h4>
                        <p>Total income from examinations completed this month.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Adding Appointment -->
<div class="modal fade" id="appointmentModal" tabindex="-1" role="dialog" aria-labelledby="appointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="appointmentModalLabel">Schedule Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'employee_dashboard' %}" id="appointmentForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" name="client_name" id="floatingClientName" placeholder="Client Name" required>
                                <label for="floatingClientName">Client Name</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="date" class="form-control" name="appointment_date" id="floatingDate" placeholder="Appointment Date" required>
                                <label for="floatingDate">Appointment Date</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <textarea class="form-control" name="description" id="floatingDescription" placeholder="Description" style="height: 100px" required></textarea>
                        <label for="floatingDescription">Description</label>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Type of Service</label>
                        <div class="row">
                            {% for service in service_types %}
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="service_types" value="{{ service.id }}" id="service{{ service.id }}">
                                    <label class="form-check-label" for="service{{ service.id }}">{{ service.name }}</label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Special Slots</label>
                        <div class="special-slots">
                            {% if form.special_slot %}
                                {{ form.special_slot }}
                            {% else %}
                                <p class="text-muted">No special slots available for this date</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Regular Time Slots</label>
                        <div class="time-slots-container">
                            {% if form.appointment_time.field.queryset.exists %}
                                {{ form.appointment_time }}
                            {% else %}
                                <div class="no-slots-available">
                                    No regular time slots available for this date
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end mt-3">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Close</button>
                        <button type="submit" name="add_appointment" class="btn btn-primary">Add Appointment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Bootstrap and jQuery JS -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function() {
        // Privacy toggle functionality
        let isBlurred = true;
        $('#togglePrivacy').click(function() {
            const incomeDisplay = $('#incomeDisplay');
            if (isBlurred) {
                incomeDisplay.removeClass('blur-text').addClass('unblur-text');
                $(this).removeClass('fa-eye-slash').addClass('fa-eye');
            } else {
                incomeDisplay.removeClass('unblur-text').addClass('blur-text');
                $(this).removeClass('fa-eye').addClass('fa-eye-slash');
            }
            isBlurred = !isBlurred;
        });
        
        // Income display click handler
        $('#incomeDisplay').click(function() {
            if (!isBlurred) {
                $('#incomeModal').modal('show');
            }
        });
        
        // Initialize tooltips
        $('[data-toggle="tooltip"]').tooltip();
        // Handle date change to load available time slots
        $('#floatingDate').change(function() {
            const selectedDate = $(this).val();
            if (!selectedDate) return;
            
            // Get today's date in YYYY-MM-DD format
            const today = new Date().toISOString().split('T')[0];
            
            // Validate if selected date is in the past
            if (selectedDate < today) {
                alert('Cannot select a date in the past');
                $(this).val('');
                $('#timeSlotsContainer').html('<div class="no-slots-available">Select a future date</div>');
                return;
            }
    
            // Validate if selected date is Sunday (0=Sunday, 6=Saturday)
            const dateObj = new Date(selectedDate);
            if (dateObj.getDay() === 0) {  // Sunday
                alert('Appointments are available Monday to Saturday only');
                $(this).val('');
                $('#timeSlotsContainer').html('<div class="no-slots-available">Select Monday-Saturday</div>');
                return;
            }
            
            // Fetch available time slots via AJAX
            $.ajax({
                url: '{% url "get_available_time_slots" %}',
                data: {
                    'date': selectedDate,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Received data:", data);  // Debug log
    
                    if (data.available_slots && data.available_slots.length > 0) {
                        let regularHtml = '';
                        let specialHtml = '';

                        data.available_slots.forEach(function(slot) {
                            if (slot.is_special) {
                                specialHtml += `
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" 
                                               name="special_slot" value="${slot.special_type}" 
                                               id="special_${slot.id}">
                                        <label class="form-check-label" for="special_${slot.id}">
                                            ${slot.special_type === 'MORNING' ? 'Whole Morning (8AM-12PM)' : 
                                              slot.special_type === 'AFTERNOON' ? 'Whole Afternoon (2PM-5PM)' : 
                                              'Whole Day (8AM-5PM)'}
                                        </label>
                                    </div>
                                `;
                            } else {
                                regularHtml += `
                                    <div class="time-slot-checkbox">
                                        <input type="checkbox" name="appointment_time" 
                                               value="${slot.id}" id="slot_${slot.id}"
                                               data-start-time="${slot.start_time}">
                                        <label for="slot_${slot.id}">${slot.start_time} - ${slot.end_time}</label>
                                    </div>
                                `;
                            }
                    });
        
                    // Update both containers
                    if (specialHtml) {
                        $('.special-slots').html(`
                            <label class="form-label">Special Slots</label>
                            ${specialHtml}
                        `);
                    } else {
                        $('.special-slots').html('<p class="text-muted">No special slots available</p>');
                    }
                    
                    if (regularHtml) {
                        $('.time-slots-container').html(`
                            <label class="form-label">Regular Slots</label>
                            ${regularHtml}
                        `);
                    } else {
                        $('.time-slots-container').html('<div class="no-slots-available">No regular slots available</div>');
                    }
                } else {
                    $('.special-slots').html('<p class="text-muted">No special slots available</p>');
                    $('.time-slots-container').html('<div class="no-slots-available">No slots available</div>');
                }
            }               
            });
        });

        $('input[name="special_slot"]').change(function() {
                if ($(this).is(':checked')) {
                    $('input[name="appointment_time"]').prop('checked', false).prop('disabled', true);
                } else {
                    $('input[name="appointment_time"]').prop('disabled', false);
                }
        });

            // Disable special slot when regular slots are selected
        $('input[name="appointment_time"]').change(function() {
                if ($('input[name="appointment_time"]:checked').length > 0) {
                    $('input[name="special_slot"]').prop('checked', false).prop('disabled', true);
                } else {
                    $('input[name="special_slot"]').prop('disabled', false);
                }
        });

        
        // Form submission validation
        $('#appointmentForm').submit(function(e) {
            const selectedSlots = $('input[name="appointment_time"]:checked').length;
            if (selectedSlots === 0) {
                e.preventDefault();
                alert(          
                    'Please select at least one Regular Time slot:\n' +
                    '(MORNING/DAY - 8:00AM)\n' +
                    '(AFTERNOON - 2:00PM)'
                );
                return false;
            }
            return true;
        });
    });
</script>
{% endblock %}