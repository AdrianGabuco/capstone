{% extends 'employee/employee_base.html' %}

{% block title %}Add Examination{% endblock %}

{% block content %}
{% load static %}
{% load widget_tweaks %}
<div class="container mt-5">
    <h2 class="mb-4 text-center">Add New Examination</h2>
    <div class="form-container border rounded p-4" style="max-height: 75vh; overflow-y: auto;">
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <fieldset class="mb-4">
                <legend class="h5">Patient Information</legend>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.first_name.label }}" class="form-label">First Name:</label>
                        {{ form.first_name|add_class:"form-control" }}
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.last_name.label }}" class="form-label">Last Name:</label>
                        {{ form.last_name|add_class:"form-control" }}
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.middle_name.label }}" class="form-label">Middle Name:</label>
                        {{ form.middle_name|add_class:"form-control" }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.age.label }}" class="form-label">Age:</label>
                        {{ form.age|add_class:"form-control" }}
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.sex.label }}" class="form-label">Sex:</label>
                        {{ form.sex|add_class:"form-select" }}
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.contact_number.label }}" class="form-label">Contact Number:</label>
                        {{ form.contact_number|add_class:"form-control" }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="{{ form.address.label }}" class="form-label">Address:</label>
                        {{ form.address|add_class:"form-control" }}
                    </div>
                </div>
                <div class="mb-3">
                    <label for="capture-image" class="form-label">Capture Patient Image</label>
                    <video id="webcam" class="w-100 mb-2" autoplay></video>
                    <button type="button" id="capture-btn" class="btn btn-primary">Capture Image</button>
                    <canvas id="canvas" style="display:none;"></canvas>
                    <input type="hidden" name="image" id="patient-image-hidden">
                </div>
            </fieldset>
            
            <fieldset class="mb-4">
                <legend class="h5">Examination Information</legend>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.service_types.label }}" class="form-label">Service Type:</label>
                        {{ form.service_types|add_class:"form-select" }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.attending_doctor.label }}" class="form-label">Attending Doctor:</label>
                        {{ form.attending_doctor|add_class:"form-select" }}
                    </div>
                </div>
            </fieldset>
            
            <fieldset class="mb-4">
                <legend class="h5">Payment Information</legend>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.method.label }}" class="form-label">Payment Method:</label>
                        {{ form.method|add_class:"form-select" }}
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.amount.label }}" class="form-label">Amount:</label>
                        {{ form.amount|add_class:"form-control" }}
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.status.label }}" class="form-label">Payment Status:</label>
                        {{ form.status|add_class:"form-select" }}
                    </div>
                </div>
            </fieldset>
            
            <div class="text-center">
                <button type="submit" class="btn btn-success px-4">Save</button>
            </div>
        </form>
    </div>
</div>


    
    <script>
        // Access the webcam and start streaming
        const video = document.getElementById('webcam');
        const captureButton = document.getElementById('capture-btn');
        const canvas = document.getElementById('canvas');
        const hiddenInput = document.getElementById('patient-image-hidden');
    
        // Start the webcam stream
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(err => {
                console.error("Error accessing webcam: ", err);
            });
    
        // Capture the image and store it in a hidden input field
        captureButton.addEventListener('click', () => {
            // Draw the video frame to the canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
    
            // Convert canvas to image data (base64) and assign it to the hidden input
            const imageData = canvas.toDataURL('image/png');
            hiddenInput.value = imageData;
    
            // Optionally, stop the webcam stream after capture
            const stream = video.srcObject;
            const tracks = stream.getTracks();
            tracks.forEach(track => track.stop());
        });
    </script>
{% endblock %}